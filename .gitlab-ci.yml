# GitLab CI/CD Pipeline for Scrimverse Backend
# This pipeline runs tests on every push/merge request

# Define stages
stages:
  - test
  - lint

# Define variables
variables:
  POSTGRES_DB: scrimverse_test_db
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  POSTGRES_HOST_AUTH_METHOD: trust
  DB_NAME: scrimverse_test_db
  DB_USER: postgres
  DB_PASSWORD: postgres
  DB_HOST: postgres
  DB_PORT: 5432
  REDIS_HOST: redis
  REDIS_PORT: 6379
  REDIS_DB: 0
  REDIS_PASSWORD: ""
  REDIS_CACHE_TTL: 300
  SECRET_KEY: test-secret-key-for-ci-cd-only
  JWT_SECRET_KEY: test-jwt-secret-key-for-ci-cd
  DEBUG: "False"
  ALLOWED_HOSTS: localhost,127.0.0.1
  CORS_ALLOWED_ORIGINS: http://localhost:3000
  ACCESS_TOKEN_LIFETIME_MINUTES: 60
  REFRESH_TOKEN_LIFETIME_DAYS: 7
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Cache dependencies to speed up builds
cache:
  paths:
    - .cache/pip
    - .venv/

# Run tests
test:
  stage: test
  image: python:3.13.7
  
  services:
    - postgres:16-alpine
    - redis:7-alpine
  
  before_script:
    - echo "Installing system dependencies..."
    - apt-get update -qy
    - apt-get install -y postgresql-client redis-tools
    
    - echo "Setting up Python virtual environment..."
    - python -m venv .venv
    - source .venv/bin/activate
    
    - echo "Installing Python dependencies..."
    - pip install --upgrade pip
    - pip install -r requirements.txt
    
    - echo "Waiting for PostgreSQL to be ready..."
    - until pg_isready -h postgres -U postgres; do echo "Waiting for postgres..."; sleep 2; done
    
    - echo "Waiting for Redis to be ready..."
    - until redis-cli -h redis ping; do echo "Waiting for redis..."; sleep 2; done
    
    - echo "Running migrations..."
    - python manage.py makemigrations
    - python manage.py migrate
  
  script:
    - echo "Running pytest with coverage..."
    - pytest --cov=. --cov-report=term --cov-report=html --cov-report=xml -v
    
    - echo "Test coverage summary:"
    - coverage report
  
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  
  artifacts:
    when: always
    paths:
      - htmlcov/
      - coverage.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 30 days
  
  only:
    - main
    - master
    - merge_requests
    - branches

# Linting job (optional but recommended)
lint:
  stage: lint
  image: python:3.13.7
  
  before_script:
    - pip install --upgrade pip
    - pip install flake8 pylint black isort
  
  script:
    - echo "Checking code formatting with black..."
    - black --check --diff . || echo "Black formatting issues found (not failing build)"
    
    - echo "Checking import sorting with isort..."
    - isort --check-only --diff . || echo "Import sorting issues found (not failing build)"
    
    - echo "Running flake8..."
    - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || echo "Flake8 errors found (not failing build)"
    
    - echo "Running pylint on main packages..."
    - pylint accounts tournaments --exit-zero || echo "Pylint issues found (not failing build)"
  
  allow_failure: true
  
  only:
    - main
    - master
    - merge_requests

# Job to check migrations
check_migrations:
  stage: test
  image: python:3.13.7
  
  services:
    - postgres:16-alpine
    - redis:7-alpine
  
  before_script:
    - echo "Installing system dependencies..."
    - apt-get update -qy
    - apt-get install -y postgresql-client
    
    - echo "Setting up Python virtual environment..."
    - python -m venv .venv
    - source .venv/bin/activate
    
    - echo "Installing Python dependencies..."
    - pip install --upgrade pip
    - pip install -r requirements.txt
    
    - echo "Waiting for PostgreSQL to be ready..."
    - until pg_isready -h postgres -U postgres; do echo "Waiting for postgres..."; sleep 2; done
  
  script:
    - echo "Checking for missing migrations..."
    - python manage.py makemigrations --check --dry-run --no-input
  
  only:
    - main
    - master
    - merge_requests

